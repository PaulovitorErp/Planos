SELECT U65.U65_CODVIN CODVINDI,
	SA1.A1_CGC CGC,
	SA1.A1_NOME CLIENTE,
	SE1.E1_NUM TITULO,
	SE1.E1_PARCELA PARCELA,
	SE1.E1_VALOR VALOR,
	SE1.E1_SALDO SALDO,
	SE1.E1_EMISSAO EMISSAO,
	SE1.E1_VENCREA VENCTO,
	SE1.E1_BAIXA BAIXA
FROM U65010 U65
INNER JOIN SE1010 SE1
	ON SE1.D_E_L_E_T_ <> '*'
	AND SE1.E1_FILIAL = '010101'
	AND SE1.E1_PREFIXO = U65.U65_PREFIX
	AND SE1.E1_NUM = U65.U65_NUM
	AND SE1.E1_PARCELA = U65.U65_PARCEL
	AND SE1.E1_TIPO = U65.U65_TIPO
	AND SE1.E1_CLIENTE = U65.U65_CLIENT
	AND SE1.E1_LOJA = U65.U65_LOJA
	AND SE1.E1_SALDO > 0
	AND SE1.E1_BAIXA = ' '
	AND SE1.E1_VENCREA <= '20200319'
INNER JOIN SA1010 SA1
	ON SA1.D_E_L_E_T_ <> '*'
	AND SA1.A1_COD = SE1.E1_CLIENTE
	AND SA1.A1_LOJA = SE1.E1_LOJA
LEFT JOIN U63010 U63
	ON U63.D_E_L_E_T_ <> '*'
	AND U63.U63_MSFIL = '010101'
	AND U63.U63_ENT = '1'
	AND U63.U63_IDVIND = U65.U65_CODVIN
WHERE U65.D_E_L_E_T_ <> '*'
	AND U65.U65_FILIAL = '010101'
	AND U65.U65_STATUS = 'A'
	AND U63.U63_IDVIND IS NULL
ORDER BY U65.U65_CONTRA;

SELECT *
FROM U63010
WHERE D_E_L_E_T_ <> '*'
AND U63_MSFIL = '010101'
AND U63_STATUS = 'E';
--AND CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)) LIKE '%event%'
--AND CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)) LIKE '%"id":69849134%';

-- Id Vindi Reprocessos
--UPDATE U63010
--SET U63_IDVIND = TRIM(JSON_VALUE(CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)), '$.bill.id'))
--WHERE D_E_L_E_T_ <> '*'
--AND U63_ENT = '1'
--AND U63_DTINC >= '20200101'
--AND U63_IDVIND = ' '
--AND CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)) NOT LIKE '%event%';

-- Id Vindi Webhooks
--UPDATE U63010
--SET U63_IDVIND = TRIM(JSON_VALUE(CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)), '$.event.data.bill.id'))
--WHERE D_E_L_E_T_ <> '*'
--AND U63_ENT = '1'
--AND U63_DTINC >= '20200101'
--AND U63_IDVIND = ' '
--AND CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)) LIKE '%event%';

SELECT * FROM U63010
WHERE D_E_L_E_T_ <> '*'
AND U63_ENT = '1'
AND U63_FILIAL = '010101'
AND TRIM(JSON_VALUE(CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)), '$.event.data.bill.charges[0].last_transaction.payment_profile.payment_company.code')) = 'visa'
AND CAST(CAST(U63_MSREC AS VARBINARY(8000)) AS VARCHAR(8000)) LIKE '%event%';

SELECT U62.R_E_C_N_O_ U62, SE1.R_E_C_N_O_ SE1, SE1.E1_NUM
FROM U62010 U62
INNER JOIN SE1010 SE1
	ON SE1.D_E_L_E_T_ <> '*'
	AND SE1.E1_FILIAL = '010101'
	AND (SE1.E1_FILIAL + SE1.E1_PREFIXO + SE1.E1_NUM + SE1.E1_PARCELA + SE1.E1_TIPO) = TRIM(U62.U62_CHAVE)
	AND SE1.E1_XFORPG = 'CC'
	AND SE1.E1_PORTADO = '999'
	AND SE1.E1_IDCNAB <> ' '
WHERE U62.D_E_L_E_T_ <> '*'
	AND U62.U62_MSFIL = '010101'
	AND U62.U62_STATUS = 'E'
ORDER BY U62.U62_CODIGO, U62.U62_DTINC, U62.U62_HRINC, U62.U62_CHAVE;

SELECT SUBSTRING(U62_CHAVE, 7, 6)
FROM U62010
WHERE D_E_L_E_T_ <> '*'
AND U62_MSFIL = '010101'
AND U62_ENT = '1'
AND U62_OPER = 'E';

SELECT U65_FILIAL, U65_CONTRA, U65_PREFIX, U65_NUM, U65_PARCEL, U65_TIPO, U65_CLIENT, U65_LOJA, COUNT(*)
FROM U65010
WHERE D_E_L_E_T_ <> '*'
AND U65_MSFIL = '010101'
AND U65_STATUS = 'A'
GROUP BY U65_FILIAL, U65_CONTRA, U65_PREFIX, U65_NUM, U65_PARCEL, U65_TIPO, U65_CLIENT, U65_LOJA
HAVING COUNT(*) > 1;

SELECT U61_CONTRA CONTRATO
FROM U61010
WHERE D_E_L_E_T_ <> '*'
AND U61_MSFIL = '010101'
AND U61_STATUS = 'A'
AND U61_CLIENT = '061884'
AND U61_LOJA = '0001'
--AND U61_CODIGO = ''

SELECT DISTINCT U65_FILIAL FILIAL,
U65_CONTRA CONTRATO,
U65_STATUS STATUS_FATURA
FROM U65010
WHERE D_E_L_E_T_ <> '*' 
AND U65_FILIAL = '010101'
AND U65_STATUS = 'A'
AND EXISTS(SELECT SUBSTRING(U62_CHAVE, 7, 6)
			FROM U62010
			WHERE D_E_L_E_T_ <> '*'
			AND U62_MSFIL = U65_FILIAL
			AND U62_ENT = '1'
			AND U62_OPER = 'E'
			AND SUBSTRING(U62_CHAVE, 7, 6) = U65_CONTRA)
GROUP BY U65_FILIAL,U65_CONTRA,U65_PREFIX,U65_NUM,U65_PARCEL,U65_TIPO,U65_STATUS;
